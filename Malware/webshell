rule webshell_jsp_converge : Webshell
{
    meta:
        author = "threatintel@volexity.com"
        description = "File upload webshell observed in incident involving compromise of Confluence server."
        date = "2022-06-01"
        memory_suitable = 1
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        
    strings:
        $s1 = "if (request.getParameter(\"name\")!=null && request.getParameter(\"name\").length()!=0){" ascii

    condition:
        $s1
}

rule general_jsp_possible_tiny_fileuploader : General Webshells
{
    meta:
        author = "threatintel@volexity.com"
        description = "Detects small .jsp files which have possible file upload utility."
        date = "2022-06-01"
        hash1 = "4addb9bc9e5e1af8fda63589f6b3fc038ccfd651230fa3fa61814ad080e95a12"
        memory_suitable = 0
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        
    strings:
        // read a req parameter of some sort
        $required1 = "request." ascii
        // write a file
        $required2 = "java.io.FileOutputStream" ascii
        $required3 = ".write" ascii

        // do some form of decoding.
        $encoding1 = "java.util.Base64" ascii
        $encoding2 = "crypto.Cipher" ascii
        $encoding3 = ".misc.BASE64Decoder" ascii

    condition:
        (
            filesize < 4KB and
            all of ($required*) and
            any of ($encoding*)
        )
        or
        (
            filesize < 600 and
            all of ($required*)
        )
}

rule webshell_java_realcmd : Commodity Webshells
{
    meta:
        author = "threatintel@volexity.com"
        description = "Detects the RealCMD webshell, one of the payloads for BEHINDER."
        date = "2022-06-01"
        hash1 = "a9a30455d6f3a0a8cd0274ae954aa41674b6fd52877fafc84a9cb833fd8858f6"
        reference = "https://github.com/Freakboy/Behinder/blob/master/src/main/java/vip/youwe/sheller/payload/java/RealCMD.java"
        memory_suitable = 1
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        
    strings:
        $fn1 = "runCmd" wide ascii fullword
        $fn2 = "RealCMD" ascii wide fullword
        $fn3 = "buildJson" ascii wide fullword
        $fn4 = "Encrypt" ascii wide fullword

        $s1 = "AES/ECB/PKCS5Padding" ascii wide
        $s2 = "python -c 'import pty; pty.spawn" ascii wide
        $s3 = "status" ascii wide
        $s4 = "success" ascii wide
        $s5 = "sun.jnu.encoding" ascii wide
        $s6 = "java.util.Base64" ascii wide

    condition:
        all of ($fn*) or
        all of ($s*)
}

rule webshell_java_behinder_shellservice : Webshells Commodity
{
    meta:
        author = "threatintel@volexity.com"
        description = "Looks for artifacts generated (generally seen in .class files) related to the Behinder framework."
        date = "2022-03-18"
        hash1 = "9a9882f9082a506ed0fc4ddaedd50570c5762deadcaf789ac81ecdbb8cf6eff2"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        reference = "https://github.com/MountCloud/BehinderClientSource/blob/master/src/main/java/net/rebeyond/behinder/core/ShellService.java"
        memory_suitable = 1

    strings:
        $s1 = "CONNECT" ascii fullword
        $s2 = "DISCONNECT" ascii fullword
        $s3 = "socket_" ascii fullword
        $s4 = "targetIP" ascii fullword
        $s5 = "targetPort" ascii fullword
        $s6 = "socketHash" ascii fullword
        $s7 = "extraData" ascii fullword

    condition:
        all of them
}

rule general_java_encoding_and_classloader : Webshells General
{
    meta:
        author = "threatintel@volexity.com"
        description = "Identifies suspicious java-based files which have all the ingredients required for a webshell."
        date = "2022-04-07"
        hash1 = "0d5dc54ef77bc18c4c5582dca4619905605668cffcccc3829e43c6d3e14ef216"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        memory_suitable = 0

    strings:
        $s1 = "javax.crypto.spec.SecretKeySpec" ascii
        $s2 = "java/security/SecureClassLoader" ascii
        $s3 = "sun.misc.BASE64Decoder" ascii

    condition:
        filesize < 50KB and
        all of them
}

rule webshell_php_str_replace_create_func : Webshells General
{
    meta:
        author = "threatintel@volexity.com"
        description = "Looks for obfuscated PHP shells where create_function() is obfuscated using str_replace and then called using no arguments."
        date = "2022-04-04"
        hash1 = "c713d13af95f2fe823d219d1061ec83835bf0281240fba189f212e7da0d94937"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        memory_suitable = 0

    strings:
        $php = "<?php"
        // $P=str_replace(
        $s = "=str_replace(" ascii
        // call it as a function
        // $S=$P('',$a);
        $anon_func = "(''," ascii
        
    condition:
        filesize < 100KB and 
        $php at 0 and
        for any i in (1..#s):
            (
                for any j in (1..#anon_func):
                    (
					    uint16be(@s[i]-2) == uint16be(@anon_func[j]-2)
					)
            )
}

rule trojan_golang_pantegana : Commodity
{
    meta:
        author = "threatintel@volexity.com"
        description = "Detects PANTEGANA, a Golang backdoor used by a range of threat actors due to its public availability."
        date = "2022-03-30"
        hash1 = "8297c99391aae918f154077c61ea94a99c7a339166e7981d9912b7fdc2e0d4f0"
        reference = "https://github.com/elleven11/pantegana"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        memory_suitable = 1

    strings:
        $s1 = "RunFingerprinter" ascii
        $s2 = "SendSysInfo" ascii
        $s3 = "ExecAndGetOutput" ascii
        $s4 = "RequestCommand" ascii
        $s5 = "bindataRead" ascii
        $s6 = "RunClient" ascii
        
        $magic = "github.com/elleven11/pantegana" ascii

    condition:
        5 of ($s*) or 
        $magic
}

rule trojan_any_pupyrat_b : Commodity
{
    meta:
        author = "threatintel@volexity.com"
        description = "Detects the PUPYRAT malware family, a cross-platform RAT written in Python."
        date = "2022-04-07"
        hash1 = "7474a6008b99e45686678f216af7d6357bb70a054c6d9b05e1817c8d80d536b4"
        reference = "https://github.com/n1nj4sec/pupy"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        memory_suitable = 1

    strings:
        $elf1 = "LD_PRELOAD=%s HOOK_EXIT=%d CLEANUP=%d exec %s 1>/dev/null 2>/dev/null" ascii
        $elf2 = "reflective_inject_dll" fullword ascii
        $elf3 = "ld_preload_inject_dll" fullword ascii
        
        $pupy1 = "_pupy.error" ascii
        $pupy2 = "_pupy" ascii
        $pupy3 = "pupy://" ascii
        
        $s1 = "Args not passed" ascii
        $s2 = "Too many args" ascii
        $s3 = "Can't execute" ascii
        $s4 = "mexec:stdin" ascii
        $s5 = "mexec:stdout" ascii
        $s6 = "mexec:stderr" ascii
        $s7 = "LZMA error" ascii


    condition:
        any of ($elf*) or 
        all of ($pupy*) or 
        all of ($s*)
}

rule general_php_fileinput_eval : Webshells General
{
    meta:
        author = "threatintel@volexity.com"
        description = "Look for PHP files which use file_get_contents and then shortly afterwards use an eval statement."
        date = "2021-06-16"
        hash1 = "1a34c43611ee310c16acc383c10a7b8b41578c19ee85716b14ac5adbf0a13bd5"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        memory_suitable = 0

    strings:
        $s1 = "file_get_contents(\"php://input\");"
        $s2 = "eval("

    condition:
        $s2 in (@s1[1]..@s1[1]+512)
}

rule general_php_call_user_func : General Webshells
{
    meta:
        author = "threatintel@volexity.com"
        description = "Webshells using call_user_func against an object from a file input or POST variable."
        date = "2021-06-16"
        hash1 = "40b053a2f3c8f47d252b960a9807b030b463ef793228b1670eda89f07b55b252"
        reference = "https://zhuanlan.zhihu.com/p/354906657"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        memory_suitable = 0

    strings:
        $s1 = "@call_user_func(new C()" wide ascii

    condition:
        $s1
}

rule webshell_php_icescorpion : Commodity Webshell
{
    meta:
        author = "threatintel@volexity.com"
        description = "Detects the IceScorpion webshell."
        date = "2022-01-17"
        hash1 = "5af4788d1a61009361b37e8db65deecbfea595ef99c3cf920d33d9165b794972"
        reference = "https://www.codenong.com/cs106064226/"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        memory_suitable = 0

    strings:
        $s1 = "[$i+1&15];"
        $s2 = "openssl_decrypt"

    condition:
        all of them and 
        filesize < 10KB
}

rule webshell_jsp_godzilla : Webshells Commodity
{
    meta:
        author = "threatintel@volexity.com"
        description = "Detects the JSP implementation of the Godzilla Webshell."
        date = "2021-11-08"
        hash1 = "2786d2dc738529a34ecde10ffeda69b7f40762bf13e7771451f13a24ab7fc5fe"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        reference = "https://github.com/BeichenDream/Godzilla"
        reference2 = "https://unit42.paloaltonetworks.com/manageengine-godzilla-nglite-kdcsponge/"
        memory_suitable = 1

    strings:
        $s1 = ".getWriter().write(base64Encode(" wide ascii
        $s2 = ".getAttribute(" ascii wide
        $s3 = "java.security.MessageDigest" ascii wide
        
        $auth1 = /String xc=\"[a-f0-9]{16}\"/ ascii wide
        $auth2 = "String pass=\"" ascii wide
        
        $magic = "class X extends ClassLoader{public X(ClassLoader z){super(z);}public Class Q"
        $magic2 = "<%@page import=\"java.util.*,javax.crypto.*,javax.crypto.spec.*\"%><%!class"

    condition:
        all of ($s*) or
        all of ($auth*) or 
        any of ($magic*)
}

rule webshell_jsp_general_runtime_exec_req: General Webshells
{
    meta:
        author = "threatintel@volexity.com"
        description = "Looks for a common design pattern in webshells where a request attribute is passed directly to exec()."
        date = "2022-02-02"
        hash1 = "4935f0c50057e28efa7376c734a4c66018f8d20157b6584399146b6c79a6de15"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        memory_suitable = 1

    strings:
        $s1 = "Runtime.getRuntime().exec(request." ascii

    condition:
        $s1
}

rule webshell_jsp_reGeorg : Webshell Commodity
{
    meta:
        author = "threatintel@volexity.com"
        description = "Detects the reGeorg webshells' JSP version."
        date = "2022-03-08"
        hash1 = "f9b20324f4239a8c82042d8207e35776d6777b6305974964cd9ccc09d431b845"
        reference = "https://github.com/SecWiki/WebShell-2/blob/master/reGeorg-master/tunnel.jsp"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        memory_suitable = 1

    strings:
        $magic = "socketChannel.connect(new InetSocketAddress(target, port))" ascii
        
        $a1 = ".connect(new InetSocketAddress" ascii
        $a2 = ".configureBlocking(false)" ascii
        $a3 = ".setHeader(" ascii
        $a4 = ".getHeader(" ascii
        $a5 = ".flip();" ascii
        
    condition:
        $magic or 
        all of ($a*)
}
